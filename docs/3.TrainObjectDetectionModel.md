# Hu·∫•n luy·ªán Object Detection Model

-----
## Train v·ªõi src/detection/train_basic.py

### Output:
```
50 epochs completed in 0.272 hours.
Optimizer stripped from ../../models/detection/basic_train/weights/last.pt, 5.4MB
Optimizer stripped from ../../models/detection/basic_train/weights/best.pt, 5.4MB

Validating ../../models/detection/basic_train/weights/best.pt...
Ultralytics 8.3.81 üöÄ Python-3.10.16 torch-2.6.0 MPS (Apple M2 Pro)
YOLO11n summary (fused): 100 layers, 2,582,542 parameters, 0 gradients, 6.3 GFLOPs
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                   all         87       1039      0.939       0.41      0.448      0.214
                  ball         86        170          1          0          0          0
                player         87        869      0.879      0.819      0.896      0.428
Speed: 0.2ms preprocess, 41.1ms inference, 0.0ms loss, 8.1ms postprocess per image
Results saved to ../../models/detection/basic_train
Hu·∫•n luy·ªán ho√†n th√†nh!
```

### ƒê√°nh gi√°:

1. **Th·ªùi gian hu·∫•n luy·ªán**: ~16 ph√∫t cho 50 epochs (0.272 gi·ªù)

2. **K·∫øt qu·∫£ ph√°t hi·ªán**:
   - **C·∫ßu th·ªß (player)**: T·ªët v·ªõi precision 0.879, recall 0.819, mAP50 l√† 0.896
   - **B√≥ng (ball)**: Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c (precision 1.0 nh∆∞ng recall 0 v√† mAP 0)
   - **T·ªïng th·ªÉ**: mAP50 ƒë·∫°t 0.448 v√† mAP50-95 ƒë·∫°t 0.214


### V·∫•n ƒë·ªÅ c·∫ßn kh·∫Øc ph·ª•c
Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c b√≥ng. Nguy√™n nh√¢n c√≥ th·ªÉ l√†:
- B√≥ng c√≥ k√≠ch th∆∞·ªõc qu√° nh·ªè trong ·∫£nh 3840x1200 khi resize xu·ªëng 640x640
- S·ªë l∆∞·ª£ng m·∫´u b√≥ng (170) √≠t h∆°n nhi·ªÅu so v·ªõi c·∫ßu th·ªß (869)

-----
## Train v·ªõi script c·∫£i ti·∫øn l·∫ßn 1: src/detectiontrain_improve1.py

### C√°c c·∫£i ti·∫øn

#### 1. TƒÉng k√≠ch th∆∞·ªõc ·∫£nh
- **imgsz=1280**: TƒÉng t·ª´ 640 l√™n 1280 ƒë·ªÉ gi·ªØ l·∫°i nhi·ªÅu chi ti·∫øt h∆°n, ƒë·∫∑c bi·ªát l√† v·ªõi qu·∫£ b√≥ng nh·ªè
- **batch=8**: Gi·∫£m batch size ƒë·ªÉ ph√π h·ª£p v·ªõi b·ªô nh·ªõ GPU khi x·ª≠ l√Ω ·∫£nh l·ªõn h∆°n

#### 2. ƒêi·ªÅu ch·ªânh loss weights
- **box=7.5**: Gi·ªØ nguy√™n tr·ªçng s·ªë cho box loss
- **cls=0.5**: Gi·ªØ nguy√™n tr·ªçng s·ªë cho class loss

#### 3. B·∫≠t augmentation
- **fliplr=0.5**: L·∫≠t ngang ·∫£nh v·ªõi x√°c su·∫•t 50% ƒë·ªÉ tƒÉng t√≠nh ƒëa d·∫°ng d·ªØ li·ªáu
- **scale=0.5**: Thay ƒë·ªïi t·ª∑ l·ªá ·∫£nh ƒë·ªÉ hu·∫•n luy·ªán m√¥ h√¨nh nh·∫≠n di·ªán ƒë·ªëi t∆∞·ª£ng ·ªü nhi·ªÅu k√≠ch th∆∞·ªõc
- **mosaic=1.0**: Gh√©p 4 ·∫£nh th√†nh 1 ƒë·ªÉ tƒÉng ƒëa d·∫°ng v√† m·∫≠t ƒë·ªô ƒë·ªëi t∆∞·ª£ng

#### 4. T·ªëi ∆∞u h√≥a cho Mac M2
- **workers=2**: Gi·∫£m s·ªë worker threads ƒë·ªÉ tr√°nh qu√° t·∫£i h·ªá th·ªëng
- **half=True**: S·ª≠ d·ª•ng half precision (FP16) ƒë·ªÉ tƒÉng t·ªëc qu√° tr√¨nh hu·∫•n luy·ªán

### Output

```
...
      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size
      22/50      10.6G      1.108        0.9     0.8667         45       1280: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 16/16 [0
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):   0%|         WARNING ‚ö†Ô∏è NMS time limit 2.800s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):  17%|‚ñà‚ñã       WARNING ‚ö†Ô∏è NMS time limit 2.800s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):  33%|‚ñà‚ñà‚ñà‚ñé     WARNING ‚ö†Ô∏è NMS time limit 2.800s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):  50%|‚ñà‚ñà‚ñà‚ñà‚ñà    WARNING ‚ö†Ô∏è NMS time limit 2.800s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):  67%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñã  WARNING ‚ö†Ô∏è NMS time limit 2.800s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95):  83%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñéWARNING ‚ö†Ô∏è NMS time limit 2.350s exceeded
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                   all         87       1039      0.942       0.17      0.181      0.125
EarlyStopping: Training stopped early as no improvement observed in last 15 epochs. Best results observed at epoch 7, best model saved as best.pt.
To update EarlyStopping(patience=15) pass a new patience value, i.e. `patience=300` or use `patience=0` to disable EarlyStopping.

22 epochs completed in 0.624 hours.
Optimizer stripped from ../../models/detection/improved_train/weights/last.pt, 5.5MB
Optimizer stripped from ../../models/detection/improved_train/weights/best.pt, 5.5MB

Validating ../../models/detection/improved_train/weights/best.pt...
Ultralytics 8.3.81 üöÄ Python-3.10.16 torch-2.6.0 MPS (Apple M2 Pro)
YOLO11n summary (fused): 100 layers, 2,582,542 parameters, 0 gradients, 6.3 GFLOPs
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                   all         87       1039      0.963      0.405      0.468       0.29
                  ball         86        170          1          0          0          0
                player         87        869      0.926       0.81      0.937       0.58
Speed: 0.5ms preprocess, 43.7ms inference, 0.0ms loss, 92.8ms postprocess per image
Results saved to ../../models/detection/improved_train
Hu·∫•n luy·ªán c·∫£i ti·∫øn ho√†n th√†nh!
```

### ƒê√°nh gi√°:

- Script d·ª´ng ·ªü epoch 22/50 do c∆° ch·∫ø Early Stopping ƒë∆∞·ª£c k√≠ch ho·∫°t
- M√¥ h√¨nh t·ªët nh·∫•t ƒë∆∞·ª£c l∆∞u ·ªü epoch 7

K·∫øt qu·∫£ c√≥ m·ªôt s·ªë c·∫£i thi·ªán nh∆∞ng v·∫´n c√≤n v·∫•n ƒë·ªÅ:

|            | C∆° b·∫£n (640) | C·∫£i ti·∫øn (1280) |
|------------|--------------|-----------------|
| mAP50      | 0.448        | 0.468           |
| mAP50-95   | 0.214        | 0.290           |
| Player mAP | 0.428        | 0.580           |
| Ball mAP   | 0.000        | 0.000           |

**K·∫øt lu·∫≠n ch√≠nh**: M√¥ h√¨nh c·∫£i thi·ªán kh·∫£ nƒÉng ph√°t hi·ªán c·∫ßu th·ªß nh∆∞ng v·∫´n **kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c b√≥ng**.

-----
## Train v·ªõi script c·∫£i ti·∫øn l·∫ßn 2: src/detectiontrain_improve2.py

### C√°c c·∫£i ti·∫øn

1. ƒêi·ªÅu ch·ªânh c√¢n b·∫±ng l·ªõp
```python
# [ball_weight, player_weight] - b√≥ng:5.0, c·∫ßu th·ªß:1.0
class_weights = torch.tensor([5.0, 1.0])
```
- **L√Ω do**: B√≥ng c√≥ √≠t m·∫´u h∆°n c·∫ßu th·ªß (170 vs 869, t·ª∑ l·ªá kho·∫£ng 1:5)
- **C√°ch ho·∫°t ƒë·ªông**: Khi m·ªôt qu·∫£ b√≥ng b·ªã b·ªè s√≥t, m√¥ h√¨nh s·∫Ω b·ªã ph·∫°t n·∫∑ng h∆°n 5 l·∫ßn so v·ªõi vi·ªác b·ªè s√≥t m·ªôt c·∫ßu th·ªß
- **K·ª≥ v·ªçng**: M√¥ h√¨nh s·∫Ω "c·ªë g·∫Øng h∆°n" ƒë·ªÉ t√¨m v√† ph√°t hi·ªán b√≥ng

2. ƒêi·ªÅu ch·ªânh tr·ªçng s·ªë loss
```python
box=10.0,  # TƒÉng t·ª´ 7.5 l√™n 10.0
cls=2.0,  # TƒÉng t·ª´ 0.5 l√™n 2.0
```
- **Box loss**: TƒÉng ƒë·ªÉ m√¥ h√¨nh t·∫≠p trung h∆°n v√†o v·ªã tr√≠ ch√≠nh x√°c c·ªßa ƒë·ªëi t∆∞·ª£ng nh·ªè
- **Class loss**: TƒÉng ƒë·ªÉ m√¥ h√¨nh nh·∫≠n di·ªán ch√≠nh x√°c c√°c l·ªõp t·ªët h∆°n ("ph·∫°t" m·∫°nh h∆°n khi m√¥ h√¨nh ph√¢n lo·∫°i sai ho·∫∑c b·ªè s√≥t ƒë·ªëi t∆∞·ª£ng b·∫•t k·ª≥)

3. C·∫£i thi·ªán augmentation cho ƒë·ªëi t∆∞·ª£ng nh·ªè
```python
scale=0.7,      # TƒÉng t·ª´ 0.5
mixup=0.3,      # Th√™m m·ªõi
copy_paste=0.1, # Th√™m m·ªõi
```
- **Scale**: TƒÉng bi·∫øn ƒë·ªïi t·ª∑ l·ªá ƒë·ªÉ t·∫°o ra nhi·ªÅu k√≠ch th∆∞·ªõc ƒë·ªëi t∆∞·ª£ng
- **Mixup**: Tr·ªôn hai ·∫£nh v·ªõi nhau, gi√∫p m√¥ h√¨nh h·ªçc c√°c ƒë·∫∑c tr∆∞ng t·ªët h∆°n
- **Copy-paste**: Sao ch√©p ƒë·ªëi t∆∞·ª£ng t·ª´ ·∫£nh n√†y sang ·∫£nh kh√°c, ƒë·∫∑c bi·ªát h·ªØu √≠ch cho l·ªõp c√≥ √≠t m·∫´u

1. TƒÉng th·ªùi gian hu·∫•n luy·ªán
```python
epochs=80,    # TƒÉng t·ª´ 50
patience=30,  # TƒÉng t·ª´ 15
```
Cho m√¥ h√¨nh nhi·ªÅu th·ªùi gian h·ªçc h∆°n

### Qu√° tr√¨nh th·ª±c hi·ªán

Script ch·∫°y ƒë·∫øn Epoch 66/80 th√¨ b√°o l·ªói: 
```
RuntimeError: MPS backend out of memory (MPS allocated: 12.13 GB, other allocations: 5.81 GB, max allowed: 18.13 GB). Tried to allocate 200.00 MB on private pool. Use PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0 to disable upper limit for memory allocations (may cause system failure).
```

L·ªói n√†y x·∫£y ra khi GPU c·ªßa Mac M2 Pro c·ªßa b·∫°n h·∫øt b·ªô nh·ªõ trong qu√° tr√¨nh hu·∫•n luy·ªán:
- **MPS ƒë√£ c·∫•p ph√°t**: 12.13 GB
- **C√°c ph·∫ßn kh√°c ƒëang s·ª≠ d·ª•ng**: 5.81 GB 
- **T·ªïng gi·ªõi h·∫°n**: 18.13 GB
- Khi c·ªë g·∫Øng c·∫•p ph√°t th√™m 200 MB, h·ªá th·ªëng kh√¥ng th·ªÉ x·ª≠ l√Ω ƒë∆∞·ª£c

Ti·∫øn h√†nh ki·ªÉm tra checkpoint:
```
(football) detection % ls -la ../../models/detection/balanced_train/weights/
total 188456
drwxr-xr-x@  8 tuantai229  staff       256 Mar  6 11:20 .
drwxr-xr-x@ 11 tuantai229  staff       352 Mar  6 11:36 ..
-rw-r--r--@  1 tuantai229  staff  16081748 Mar  6 11:25 best.pt
-rw-r--r--@  1 tuantai229  staff  16074004 Mar  6 09:02 epoch0.pt
-rw-r--r--@  1 tuantai229  staff  16076244 Mar  6 09:48 epoch20.pt
-rw-r--r--@  1 tuantai229  staff  16078804 Mar  6 10:41 epoch40.pt
-rw-r--r--@  1 tuantai229  staff  16081364 Mar  6 11:20 epoch60.pt
-rw-r--r--@  1 tuantai229  staff  16081876 Mar  6 11:26 last.pt
```

- `best.pt`: M√¥ h√¨nh t·ªët nh·∫•t theo metrics ƒë√°nh gi√°
- `last.pt`: M√¥ h√¨nh t·∫°i epoch cu·ªëi c√πng tr∆∞·ªõc khi g·∫∑p l·ªói b·ªô nh·ªõ
- C√°c checkpoint trung gian t·∫°i epoch 0, 20, 40, v√† 60

Vi·∫øt file ƒë√°nh gi√° xem c√≥ c·∫£i thi·ªán kh√¥ng `src/detection/evaluate_model.py`
```
(football) detection % python evaluate_model.py
ƒêang ƒë√°nh gi√° model: ../../models/detection/balanced_train/weights/best.pt
Ultralytics 8.3.81 üöÄ Python-3.10.16 torch-2.6.0 MPS (Apple M2 Pro)
YOLO11n summary (fused): 100 layers, 2,582,542 parameters, 0 gradients, 6.3 GFLOPs
val: Scanning /Users/tuantai229/Projects/FootballDnC/dataset/val/labels.cache... 87 images, 0 background
                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                   all         87       1039      0.828        0.5      0.515      0.353
                  ball         86        170      0.765     0.0412     0.0562     0.0168
                player         87        869      0.891       0.96      0.974      0.689
Speed: 1.1ms preprocess, 24.1ms inference, 0.0ms loss, 26.3ms postprocess per image
Results saved to runs/detect/val

K·∫øt qu·∫£ ƒë√°nh gi√°:
mAP50: 0.515
mAP50-95: 0.353

K·∫øt qu·∫£ theo l·ªõp:
0: mAP50 = 0.017
1: mAP50 = 0.689
```

Ph√¢n t√≠ch k·∫øt qu·∫£ ƒë√°nh gi√° m√¥ h√¨nh:

1. ƒê√£ b·∫Øt ƒë·∫ßu ph√°t hi·ªán ƒë∆∞·ª£c b√≥ng!
- **Tr∆∞·ªõc ƒë√¢y**: mAP50 = 0.000 (kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c b√≥ng)
- **Hi·ªán t·∫°i**: mAP50 = 0.0562 (ƒë√£ b·∫Øt ƒë·∫ßu ph√°t hi·ªán)

2. Ph√¢n t√≠ch chi ti·∫øt t·ª´ng l·ªõp:

| L·ªõp | Precision | Recall | mAP50 | mAP50-95 |
|-----|-----------|--------|-------|----------|
| Ball | 0.765 | 0.0412 | 0.0562 | 0.0168 |
| Player | 0.891 | 0.960 | 0.974 | 0.689 |
| Overall | 0.828 | 0.500 | 0.515 | 0.353 |

- **ƒêi·ªÉm m·∫°nh**: Khi m√¥ h√¨nh ph√°t hi·ªán b√≥ng, ƒë·ªô ch√≠nh x√°c kh√° t·ªët (Precision = 0.765)
- **H·∫°n ch·∫ø ch√≠nh**: T·ª∑ l·ªá ph√°t hi·ªán b√≥ng c√≤n th·∫•p (Recall = 0.0412), ch·ªâ t√¨m th·∫•y kho·∫£ng 4% s·ªë qu·∫£ b√≥ng

-----
## Train script tr√™n Kaggle v·ªõi nhi·ªÅu tham s·ªë kh√°c nhau: src/train_experiment.py

B·∫£ng so s√°nh k·∫øt qu·∫£ ·ªü src/detection/experiment.xlsx

